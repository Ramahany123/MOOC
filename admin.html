<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - French MOOC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .card {
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-table th,
        .stats-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: top; 
        }

        .stats-table th {
            background-color: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            color: #4b5563;
        }

        .stats-table tbody tr:hover {
            background-color: #f3f4f6;
        }

        .student-name {
            font-weight: 500;
            color: #1f2937;
        }

        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.5s ease-in-out;
        }

        .score-cell {
            font-weight: 500; 
            white-space: normal; 
        }

        .score-high {
            color: #10b981; /* Green */
            font-weight: 700;
        }

        .score-medium {
            color: #f59e0b; /* Yellow/Orange */
            font-weight: 700;
        }

        .score-low {
            color: #ef4444; /* Red */
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }

            .stats-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>

    <div class="admin-container">
        <header class="admin-header mb-8 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900">Admin Dashboard</h1>
            <p class="text-gray-500 mt-1">Student Progress Overview</p>
        </header>

        <section class="summary-cards grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="icon text-3xl text-blue-500 bg-blue-500/10 p-4 rounded-full">ðŸ‘¥</div>
                <div class="card-info">
                    <h3 class="text-sm font-medium text-gray-500">Total Students</h3>
                    <p class="value text-3xl font-bold text-gray-900" id="total-students">Loading...</p>
                </div>
            </div>
            <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="icon text-3xl text-green-500 bg-green-500/10 p-4 rounded-full">ðŸ“ˆ</div>
                <div class="card-info">
                    <h3 class="text-sm font-medium text-gray-500">Avg. Completion</h3>
                    <p class="value text-3xl font-bold text-gray-900" id="avg-completion">Loading...</p>
                </div>
            </div>
            <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center space-x-4">
                <div class="icon text-3xl text-yellow-500 bg-yellow-500/10 p-4 rounded-full">âœ…</div>
                <div class="card-info">
                    <h3 class="text-sm font-medium text-gray-500">Avg. Quiz Score</h3>
                    <p class="value text-3xl font-bold text-gray-900" id="avg-quiz-score">Loading...</p>
                </div>
            </div>
        </section>

        <section class="stats-container bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Detailed Student Progress</h2>
            <div class="overflow-x-auto">
                <table class="stats-table min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Videos Watched</th>
                            <th>Video Progress</th>
                            <th>Audio Listened</th>
                            <th>Audio Progress</th>
                            <th>Quiz 1 Scores</th>
                            <th>Quiz 2 Scores</th>
                            <th>Quiz 3 Scores</th>
                            <th>Quiz 4 Scores</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="10" class="text-center py-4 text-gray-500">Connecting to Firebase...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnCovkec0YaXmgpcnNLx1qiCpGG7-iipU",
            authDomain: "educational-site-f1fac.firebaseapp.com",
            databaseURL: "https://educational-site-f1fac-default-rtdb.firebaseio.com",
            projectId: "educational-site-f1fac",
            storageBucket: "educational-site-f1fac.firebasestorage.app",
            messagingSenderId: "868437050505",
            appId: "1:868437050505:web:8ca5d61feee67a67647258",
            measurementId: "G-785N8W65W5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- CONSTANTS ---
        const TOTAL_VIDEOS = 4;
        const TOTAL_AUDIOS = 3;
        const QUIZ_IDS = ['quiz-1', 'quiz-2', 'quiz-3', 'quiz-4'];


        // Helper function to determine score class for styling based on the best score
        function getScoreClass(score) {
            // The score input might be a string like '90%, 80%' or a number
            if (typeof score === 'string') {
                const match = score.match(/^(\d+)%/);
                score = match ? parseInt(match[1]) : NaN;
            }
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) return '';
            if (numericScore >= 80) return 'score-high';
            if (numericScore >= 60) return 'score-medium';
            return 'score-low';
        }

        // Process the data for display
        function processData(users, tracking) {
            // Calculate summary statistics
            let totalStudents = 0;
            let totalVideoProgress = 0;
            let totalAudioProgress = 0;
            let totalQuizScoreSum = 0; // Sum of ALL attempt scores for average
            let quizAttemptsCounted = 0; // Count of ALL attempts for average
            let usersWithVideoData = 0;
            let usersListenAudioData = 0;

            // Prepare table data
            const tableRows = [];

            // Process each user
            for (const userId in users) {
                // Skip the admin account
                if (userId === "01000000000") {
                    continue;
                }

                totalStudents++;

                const user = users[userId];
                const userTracking = tracking && tracking[userId] ? tracking[userId] : {};

                // --- Video and Audio Tracking ---
                const videoTracking = userTracking.video_tracking || {};
                const audioTracking = userTracking.audio_tracking || {};
                const videosWatched = Object.keys(videoTracking).length;
                const audiosListened = Object.keys(audioTracking).length;

                let videoProgress = 0;
                if (videosWatched > 0) {
                    let totalWatchedTime = 0;
                    let totalDuration = 0;
                    for (const videoId in videoTracking) {
                        const video = videoTracking[videoId];
                        totalWatchedTime += video.last_watched_time || 0;
                        totalDuration += video.total_duration || 1;
                    }
                    videoProgress = Math.round((totalWatchedTime / totalDuration) * 100);
                    totalVideoProgress += videoProgress;
                    usersWithVideoData++;
                }

                let audioProgress = 0;
                if (audiosListened > 0) {
                    let totalListenedTime = 0;
                    let totalDuration = 0;
                    for (const AudioId in audioTracking) {
                        const audio = audioTracking[AudioId];
                        totalListenedTime += audio.last_listened_time || 0;
                        totalDuration += audio.total_duration || 1;
                    }
                    audioProgress = Math.round((totalListenedTime / totalDuration) * 100);
                    totalAudioProgress += audioProgress;
                    usersListenAudioData++;
                }
                // --- End Video/Audio Logic ---

                // --- QUIZ SCORING LOGIC: Show ALL Scores as List (Sorted) ---
                const quizzes = userTracking.quizzes || {};
                const quizScoresDisplay = {};

                for (const quizId of QUIZ_IDS) {
                    const attempts = (quizzes[quizId] && quizzes[quizId].attempts) || {};
                    let allScores = [];

                    // 1. Collect all scores and update global average counts
                    for (const attemptId in attempts) {
                        const score = attempts[attemptId].score || 0;
                        allScores.push(score);

                        // Update global average statistics
                        totalQuizScoreSum += score;
                        quizAttemptsCounted++;
                    }

                    // 2. Sort scores from best to worst
                    const sortedScores = allScores.sort((a, b) => b - a);

                    // 3. Format scores into the requested comma-separated list
                    const formattedScores = sortedScores
                        .map(s => `${s}%`)
                        .join(', ');

                    const quizNumber = quizId.split('-')[1];

                    // 4. Display all scores, using the best score for the color class
                    // Pass the whole formattedScores string to getScoreClass for color coding
                    quizScoresDisplay[`quiz${quizNumber}`] = allScores.length > 0 ?
                        `<span class="${getScoreClass(formattedScores)}">${formattedScores}</span>` :
                        '-';
                }
                // --- END QUIZ SCORING LOGIC ---


                // Create table row for this user
                tableRows.push(`
                    <tr>
                        <td class="student-name">${user.name || 'Unknown'}</td>
                        <td class="text-center">${videosWatched}</td>
                        <td>
                            <div class="flex items-center space-x-2">
                                <div class="progress-bar w-24">
                                    <div class="progress-fill" style="width: ${videoProgress}%"></div>
                                </div>
                                <span class="text-sm">${videoProgress}%</span>
                            </div>
                        </td>
                        <td class="text-center">${audiosListened}</td>
                        <td>
                            <div class="flex items-center space-x-2">
                                <div class="progress-bar w-24">
                                    <div class="progress-fill" style="width: ${audioProgress}%"></div>
                                </div>
                                <span class="text-sm">${audioProgress}%</span>
                            </div>
                        </td>
                        <td class="score-cell text-center">${quizScoresDisplay.quiz1 || '-'}</td>
                        <td class="score-cell text-center">${quizScoresDisplay.quiz2 || '-'}</td>
                        <td class="score-cell text-center">${quizScoresDisplay.quiz3 || '-'}</td>
                        <td class="score-cell text-center">${quizScoresDisplay.quiz4 || '-'}</td>
                    </tr>
                `);
            }

            // Update summary cards
            document.getElementById('total-students').textContent = totalStudents;

            // FIX: Correctly calculate average completion by averaging only existing data sources
            const avgVideo = usersWithVideoData > 0 ? (totalVideoProgress / usersWithVideoData) : 0;
            const avgAudio = usersListenAudioData > 0 ? (totalAudioProgress / usersListenAudioData) : 0;
            let avgCompletion = 0;

            if (usersWithVideoData > 0 || usersListenAudioData > 0) {
                // Determine how many progress sources to divide by (1 or 2)
                const validSources = (usersWithVideoData > 0) + (usersListenAudioData > 0); 
                avgCompletion = Math.round((avgVideo + avgAudio) / validSources);
            }

            document.getElementById('avg-completion').textContent = `${avgCompletion}%`;

            // Calculate average quiz score based on ALL attempt scores
            document.getElementById('avg-quiz-score').textContent =
                quizAttemptsCounted > 0 ? Math.round(totalQuizScoreSum / quizAttemptsCounted) + '%' : '0%';

            // Update table
            const tableBody = document.getElementById('stats-table-body');
            if (tableRows.length > 0) {
                tableBody.innerHTML = tableRows.join('');
            } else {
                // FIX: colspan must be 10
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center py-4 text-gray-500">No student data found.</td></tr>';
            }
        }

        // Function to fetch and process data
        async function fetchData() {
            try {
                document.getElementById('stats-table-body').innerHTML =
                    '<tr><td colspan="10" class="text-center py-4 text-gray-500">Fetching data from Firebase...</td></tr>';

                const usersSnapshot = await database.ref('users').once('value');
                const trackingSnapshot = await database.ref('tracking').once('value');

                const users = usersSnapshot.val() || {};
                const tracking = trackingSnapshot.val() || {};

                if (Object.keys(users).length === 0) {
                    throw new Error('No users data found');
                }

                processData(users, tracking);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('stats-table-body').innerHTML =
                    '<tr><td colspan="10" class="text-center py-4 text-red-500">Error loading data: ' + error.message + '</td></tr>';

                // Set default values on error
                document.getElementById('total-students').textContent = 'Error';
                document.getElementById('avg-completion').textContent = 'Error';
                document.getElementById('avg-quiz-score').textContent = 'Error';
            }
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>

</body>

</html>